<!DOCTYPE html>
<html>
  <head>
    <title>AR Poster Scanner</title>
    <meta charset="utf-8" />
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body, html {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
        background-color: black;
      }

      #tracking-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 24px;
        text-align: center;
        z-index: 10;
        background-color: rgba(0, 0, 0, 0.4);
        padding: 20px;
        border-radius: 10px;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="tracking-overlay">Point your camera at the poster</div>

    <a-scene mindar-image="imageTargetSrc: targets.mind; autoStart: true;" embedded color-space="sRGB" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: true">
      <a-assets>
        <video id="video0" src="video0.mp4" preload="auto" crossorigin="anonymous" webkit-playsinline playsinline></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane id="video-plane" position="0 0 -0.01" rotation="0 0 0" material="shader: flat; src: #video0; transparent: true; opacity: 0;"></a-plane>
      </a-entity>
    </a-scene>

    <script>
      const physicalWidth = 85.6001;  // in cm
      const physicalHeight = 206.6001; // in cm

      const targetEntity = document.querySelector('[mindar-image-target="targetIndex: 0"]');
      const video = document.querySelector("#video0");
      const plane = document.querySelector("#video-plane");
      const trackingOverlay = document.getElementById("tracking-overlay");

      targetEntity.addEventListener("targetFound", () => {
        console.log("Target found");

        // Hide overlay immediately
        trackingOverlay.classList.add("hidden");

        // Set correct aspect ratio
        const ratio = physicalHeight / physicalWidth;
        const targetWidth = 1; // unit A-Frame scale
        const targetHeight = targetWidth * ratio;

        plane.setAttribute("width", targetWidth);
        plane.setAttribute("height", targetHeight);
        plane.setAttribute("rotation", "0 0 0");
        plane.getObject3D("mesh").material.opacity = 1;

        // Try to autoplay
        const playPromise = video.play();
        if (playPromise !== undefined) {
          playPromise.catch(() => {
            video.muted = true;
            video.play().then(() => {
              document.addEventListener("touchstart", () => {
                video.muted = false;
              }, { once: true });

              document.addEventListener("click", () => {
                video.muted = false;
              }, { once: true });
            });
          });
        }
      });

      targetEntity.addEventListener("targetLost", () => {
        console.log("Target lost");
        video.pause();
        video.currentTime = 0;
        plane.getObject3D("mesh").material.opacity = 0;
      });
    </script>
  </body>
</html>
